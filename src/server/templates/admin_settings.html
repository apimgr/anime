{{define "content"}}
<!-- Admin Settings Header -->
<div class="admin-header">
    <div>
        <h1>Server Settings</h1>
        <p style="color: var(--text-secondary); margin: 0;">Configure server settings with live reload</p>
    </div>
    <div class="admin-actions">
        <button class="btn btn-secondary" onclick="exportSettings()">Export Settings</button>
        <button class="btn btn-warning" onclick="resetSettings()">Reset to Defaults</button>
        <button class="btn btn-secondary" onclick="window.location.href='/admin'">Back to Dashboard</button>
    </div>
</div>

<!-- Settings Categories -->
<div class="admin-section">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Settings Categories</h3>
        </div>
        <div class="card-body">
            <div class="tabs">
                <button class="tab-btn active" onclick="showCategory('cors')">CORS</button>
                <button class="tab-btn" onclick="showCategory('rate_limiting')">Rate Limiting</button>
                <button class="tab-btn" onclick="showCategory('request_limits')">Request Limits</button>
                <button class="tab-btn" onclick="showCategory('connection_limits')">Connection Limits</button>
                <button class="tab-btn" onclick="showCategory('security')">Security Headers</button>
            </div>
        </div>
    </div>
</div>

<!-- Settings Forms Container -->
<div id="settings-container">
    <div class="loading-message">Loading settings...</div>
</div>

<!-- Import Settings Modal -->
<div id="import-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h2>Import Settings</h2>
        <p>Paste your settings JSON below:</p>
        <textarea id="import-json" rows="10" style="width: 100%; font-family: monospace; padding: 8px;"></textarea>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button class="btn btn-primary" onclick="performImport()">Import</button>
            <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Admin Settings JavaScript -->
<style>
.tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.tab-btn {
    padding: 8px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s;
}

.tab-btn:hover {
    background: var(--bg-tertiary);
}

.tab-btn.active {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
}

.settings-category {
    display: none;
}

.settings-category.active {
    display: block;
}

.settings-grid {
    display: grid;
    gap: 16px;
    margin-top: 16px;
}

.setting-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
}

.setting-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.setting-label {
    font-weight: 600;
    color: var(--text-primary);
}

.setting-type {
    font-size: 0.75rem;
    padding: 2px 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    color: var(--text-secondary);
}

.setting-description {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

.setting-input {
    width: 100%;
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
}

.setting-input:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.setting-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.badge-reload {
    display: inline-block;
    font-size: 0.75rem;
    padding: 2px 8px;
    background: var(--accent-warning);
    color: white;
    border-radius: 4px;
    margin-left: 8px;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    max-width: 600px;
    width: 90%;
}

.loading-message {
    text-align: center;
    padding: 32px;
    color: var(--text-secondary);
}
</style>

<script>
let allSettings = {};
let currentCategory = 'cors';

/**
 * Load all settings from the server
 */
async function loadSettings() {
    try {
        const response = await fetch('/api/v1/admin/settings', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });

        if (!response.ok) {
            throw new Error('Failed to load settings');
        }

        const data = await response.json();
        allSettings = data.settings || {};

        renderSettings();
        showToast('Settings loaded successfully', 'success', 2000);
    } catch (error) {
        console.error('Error loading settings:', error);
        showToast('Failed to load settings: ' + error.message, 'error');
    }
}

/**
 * Render settings for all categories
 */
function renderSettings() {
    const container = document.getElementById('settings-container');
    container.innerHTML = '';

    const categories = {
        'cors': 'CORS Settings',
        'rate_limiting': 'Rate Limiting',
        'request_limits': 'Request Limits',
        'connection_limits': 'Connection Limits',
        'security': 'Security Headers'
    };

    for (const [category, title] of Object.entries(categories)) {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'settings-category' + (category === currentCategory ? ' active' : '');
        categoryDiv.id = 'category-' + category;

        const settings = allSettings[category] || [];

        let html = `
            <div class="admin-section">
                <h2 class="admin-section-title">${title}</h2>
                <div class="card">
                    <div class="card-body">
                        <div class="settings-grid">
        `;

        settings.forEach(setting => {
            const inputType = setting.Type === 'bool' ? 'checkbox' : 'text';
            const value = setting.Type === 'bool' ? (setting.Value === 'true') : setting.Value;
            const checked = setting.Type === 'bool' && value ? 'checked' : '';

            html += `
                <div class="setting-item">
                    <div class="setting-header">
                        <div class="setting-label">
                            ${setting.Key.replace(/_/g, ' ').toUpperCase()}
                            ${setting.RequiresReload ? '<span class="badge-reload">Requires Reload</span>' : ''}
                        </div>
                        <span class="setting-type">${setting.Type}</span>
                    </div>
                    <div class="setting-description">${setting.Description || 'No description'}</div>
            `;

            if (setting.Type === 'bool') {
                html += `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="setting-${setting.Key}" ${checked}
                               style="margin-right: 8px; cursor: pointer;">
                        <span>Enabled</span>
                    </label>
                `;
            } else if (setting.Type === 'json') {
                html += `
                    <textarea id="setting-${setting.Key}" class="setting-input"
                              rows="3">${value}</textarea>
                `;
            } else {
                html += `
                    <input type="text" id="setting-${setting.Key}" class="setting-input"
                           value="${value}">
                `;
            }

            html += `
                    <div class="setting-actions">
                        <button class="btn btn-sm btn-primary" onclick="saveSetting('${setting.Key}', '${setting.Type}')">
                            Save
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="resetSetting('${setting.Key}')">
                            Reset
                        </button>
                    </div>
                </div>
            `;
        });

        html += `
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="saveCategory('${category}')">
                        Save All ${title}
                    </button>
                </div>
            </div>
        `;

        categoryDiv.innerHTML = html;
        container.appendChild(categoryDiv);
    }
}

/**
 * Show a specific category
 */
function showCategory(category) {
    currentCategory = category;

    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Update category visibility
    document.querySelectorAll('.settings-category').forEach(cat => {
        cat.classList.remove('active');
    });
    document.getElementById('category-' + category).classList.add('active');
}

/**
 * Save a single setting
 */
async function saveSetting(key, type) {
    try {
        const element = document.getElementById('setting-' + key);
        let value;

        if (type === 'bool') {
            value = element.checked ? 'true' : 'false';
        } else {
            value = element.value;
        }

        const response = await fetch('/api/v1/admin/settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify({
                [key]: value
            })
        });

        if (!response.ok) {
            throw new Error('Failed to save setting');
        }

        const result = await response.json();

        if (result.requires_reload) {
            showToast('Setting saved! Server reload may be required.', 'warning', 4000);
        } else {
            showToast('Setting saved successfully', 'success', 2000);
        }

        // Reload settings to get updated values
        await loadSettings();
    } catch (error) {
        console.error('Error saving setting:', error);
        showToast('Failed to save setting: ' + error.message, 'error');
    }
}

/**
 * Save all settings in a category
 */
async function saveCategory(category) {
    try {
        const settings = allSettings[category] || [];
        const updates = {};

        settings.forEach(setting => {
            const element = document.getElementById('setting-' + setting.Key);
            if (element) {
                if (setting.Type === 'bool') {
                    updates[setting.Key] = element.checked ? 'true' : 'false';
                } else {
                    updates[setting.Key] = element.value;
                }
            }
        });

        const response = await fetch('/api/v1/admin/settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(updates)
        });

        if (!response.ok) {
            throw new Error('Failed to save settings');
        }

        const result = await response.json();

        if (result.requires_reload) {
            showToast(`Saved ${result.updated_count} settings! Server reload may be required.`, 'warning', 4000);
        } else {
            showToast(`Saved ${result.updated_count} settings successfully`, 'success', 2000);
        }

        // Reload settings
        await loadSettings();
    } catch (error) {
        console.error('Error saving category:', error);
        showToast('Failed to save settings: ' + error.message, 'error');
    }
}

/**
 * Reset a single setting to default
 */
async function resetSetting(key) {
    if (!confirm('Reset this setting to default value?')) {
        return;
    }

    // For now, just reload the original value
    await loadSettings();
    showToast('Setting reset to current value', 'info', 2000);
}

/**
 * Reset all settings to defaults
 */
async function resetSettings() {
    if (!confirm('Reset ALL settings to their default values? This cannot be undone!')) {
        return;
    }

    try {
        const response = await fetch('/api/v1/admin/settings/reset', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });

        if (!response.ok) {
            throw new Error('Failed to reset settings');
        }

        showToast('All settings reset to defaults successfully', 'success', 3000);
        await loadSettings();
    } catch (error) {
        console.error('Error resetting settings:', error);
        showToast('Failed to reset settings: ' + error.message, 'error');
    }
}

/**
 * Export settings to JSON file
 */
async function exportSettings() {
    try {
        const response = await fetch('/api/v1/admin/settings/export', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });

        if (!response.ok) {
            throw new Error('Failed to export settings');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'anime-settings.json';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showToast('Settings exported successfully', 'success', 2000);
    } catch (error) {
        console.error('Error exporting settings:', error);
        showToast('Failed to export settings: ' + error.message, 'error');
    }
}

/**
 * Show import modal
 */
function showImportModal() {
    document.getElementById('import-modal').style.display = 'flex';
}

/**
 * Close import modal
 */
function closeImportModal() {
    document.getElementById('import-modal').style.display = 'none';
    document.getElementById('import-json').value = '';
}

/**
 * Perform settings import
 */
async function performImport() {
    try {
        const jsonText = document.getElementById('import-json').value;
        const settings = JSON.parse(jsonText);

        const response = await fetch('/api/v1/admin/settings/import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(settings)
        });

        if (!response.ok) {
            throw new Error('Failed to import settings');
        }

        const result = await response.json();
        showToast(`Imported ${result.imported_count} settings successfully`, 'success', 3000);

        closeImportModal();
        await loadSettings();
    } catch (error) {
        console.error('Error importing settings:', error);
        showToast('Failed to import settings: ' + error.message, 'error');
    }
}

// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
});
</script>
{{end}}
